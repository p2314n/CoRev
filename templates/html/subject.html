<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ subject.name or subject.id }} Details</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subject.css') }}">
</head>
<body>
  <div class="subject-container">
    <h1 id="subject-name">{{ subject.name or subject.id }}</h1>
    <p id="subject-description" class="subject-description">{{ subject.desc }}</p>

   <!-- üîî Flash Messages (only for review actions) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            {% if category == 'review' %}
              <div class="flash">{{ message }}</div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- ‚≠ê Average Rating Display -->
    <div class="average-rating">
      {% if avg_rating %}
        ‚≠ê <strong>{{ avg_rating }}</strong>/5 ({{ review_count }} rating{{ 's' if review_count != 1 else '' }})
      {% else %}
        ‚≠ê No ratings yet
      {% endif %}
    </div>

    <!-- ‚úèÔ∏è Review Form -->
    <div class="review-box">
      <h2>Leave a Review</h2>

      <!-- Main Review Form -->
      <form method="POST" action="{{ url_for('subject_bp.add_review', subject_id=subject.id) }}">
        <label for="rating">Rating:</label>

        <!-- Stars -->
        <div class="star-rating" id="starRating">
          {% for i in range(1, 6) %}
            <span class="star" data-value="{{ i }}">‚òÖ</span>
          {% endfor %}
        </div>

        <input type="hidden" name="rating" id="ratingInput">

        <label for="review-text">Review:</label>
        <textarea name="review" id="review-text" placeholder="Write your review..."></textarea>

        <button type="submit" id="submit-review">
          {% if user_review %}Update Review{% else %}Submit Review{% endif %}
        </button>
      </form>

      <!-- Separate Delete Form -->
      {% if user_review %}
        <form method="POST" action="{{ url_for('subject_bp.delete_review', subject_id=subject.id) }}" class="delete-form" onsubmit="return confirm('Are you sure you want to delete your review?');">
          <button type="submit" class="delete-btn">Delete My Review</button>
        </form>
      {% endif %}
    </div>
    <!-- üí¨ Reviews List -->
    <div class="reviews-list">
      <h2>All Reviews</h2>

      {% if reviews %}
        {% for r in reviews %}
          <div class="review-card">
           <div class="review-header">
              <div>
                <span class="review-user">{{ r.user_name }}</span>
                {% if r.designation %}
                  <span class="review-designation"> ({{ r.designation }})</span>
                {% endif %}
              </div>
              <span class="review-date">{{ r.created_at.strftime('%d %b %Y') }}</span>
            </div>
            <div class="review-rating">
              {% if r.rating %}
                {{ '‚òÖ' * r.rating }} ({{ r.rating }}/5)
              {% else %}
                <em>No rating given</em>
              {% endif %}
            </div>
            <div class="review-text">
              {% if r.review %}
                {{ r.review }}
              {% else %}
                <em>No review text</em>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>No reviews yet ‚Äî be the first to write one!</p>
      {% endif %}
    </div>
  </div>
  <script src="{{ url_for('static', filename='js/subject.js') }}"></script>
</body>
</html>